<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Checkout</title>
  <style>
    body{font-family:Arial,Helvetica,sans-serif;background:#f9fafb;margin:0;padding:20px}
    h1{text-align:center;margin-bottom:20px}
    .card{background:#fff;padding:16px;border-radius:12px;box-shadow:0 4px 10px rgba(0,0,0,0.05);margin-bottom:16px}
    .item{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
    .item:last-child{margin-bottom:0}
    .total{font-weight:bold;font-size:18px;text-align:right;margin-top:10px}
    label{display:block;margin:8px 0 4px}
    input,textarea{padding:8px;width:100%;border:1px solid #ccc;border-radius:6px}
    textarea{resize:vertical;min-height:60px}
    .radio-group{display:flex;gap:20px;margin-top:10px}
    .radio-group label{display:flex;align-items:center;gap:6px;margin:0}
    .hidden{display:none}
    button{margin-top:20px;width:100%;padding:12px;border:none;background:#2563eb;color:#fff;font-size:16px;font-weight:600;border-radius:8px;cursor:pointer}
  </style>
</head>
<body>
  <h1>Checkout</h1>

  <div class="card" id="cartList"></div>

  <div class="card">
    <h3>Data Pembeli</h3>
    <label>Nama</label>
    <input type="text" id="buyerName" required>
    <label>Nomor WhatsApp</label>
    <input type="text" id="buyerWa" required>
    <label>Alamat</label>
    <textarea id="buyerAddress" required></textarea>
  </div>

  <div class="card">
    <h3>Metode Pembayaran</h3>
    <div class="radio-group">
      <label><input type="radio" name="payment" value="dana"> DANA</label>
      <label><input type="radio" name="payment" value="cash"> Cash</label>
    </div>
    <!-- jika pilih dana -->
    <div id="uploadBox" class="hidden">
      <label>Upload Bukti Pembayaran (screenshot)</label>
      <input type="file" id="proof" accept="image/*">
    </div>
    <!-- jika pilih cash -->
    <div id="noteBox" class="hidden">
      <label>Catatan</label>
      <textarea id="cashNote" placeholder="Contoh: COD, diantarkan ke rumah, uang pas, dll."></textarea>
    </div>
  </div>

  <button id="confirmBtn">Konfirmasi Pesanan</button>

  <script>
    const KEY_CART = 'cart';
    const KEY_USER = 'users';
    const KEY_NOTE = 'lastNote'; // simpan catatan terakhir
    const products = [
      {id:1,name:'lumpia',price:5000},
      {id:2,name:'cilok',price:5000},
      {id:3,name:'cireng',price:10000},
      {id:4,name:'air',price:15000}
    ];

    function formatRp(n){
      return 'Rp ' + n.toLocaleString('id-ID');
    }

    function renderCart(){
      const cartData = JSON.parse(localStorage.getItem(KEY_CART)) || {};
      const container = document.getElementById('cartList');
      container.innerHTML = '<h3>Daftar Produk</h3>';
      let total = 0;

      for(const id in cartData){
        const qty = cartData[id];
        const product = products.find(p=>p.id==id);
        if(product){
          const sub = product.price * qty;
          total += sub;
          container.innerHTML += `
            <div class="item">
              <span>${product.name} x ${qty}</span>
              <span>${formatRp(sub)}</span>
            </div>
          `;
        }
      }

      container.innerHTML += `<div class="total">Total: ${formatRp(total)}</div>`;
    }

    function fillBuyerData(){
      let userData = localStorage.getItem(KEY_USER);
      if(userData){
        userData = JSON.parse(userData);
        if(Array.isArray(userData)) userData = userData[0];
        if(userData.name) document.getElementById('buyerName').value = userData.name;
        if(userData.wa) document.getElementById('buyerWa').value = userData.wa;
        if(userData.address) document.getElementById('buyerAddress').value = userData.address;
      }

      // isi catatan terakhir kalau ada
      const lastNote = localStorage.getItem(KEY_NOTE);
      if(lastNote){
        document.getElementById('cashNote').value = lastNote;
      }
    }

    // toggle sesuai pilihan pembayaran
    document.querySelectorAll('input[name="payment"]').forEach(radio=>{
      radio.addEventListener('change',()=>{
        if(radio.value==='dana'){
          document.getElementById('uploadBox').classList.remove('hidden');
          document.getElementById('noteBox').classList.add('hidden');
        } else {
          document.getElementById('uploadBox').classList.add('hidden');
          document.getElementById('noteBox').classList.remove('hidden');
        }
      });
    });

    document.getElementById('confirmBtn').addEventListener('click',()=>{
      const name = document.getElementById('buyerName').value.trim();
      const wa = document.getElementById('buyerWa').value.trim();
      const address = document.getElementById('buyerAddress').value.trim();
      const payment = document.querySelector('input[name="payment"]:checked');

      if(!name || !wa || !address || !payment){
        alert('Lengkapi data terlebih dahulu!');
        return;
      }
      if(payment.value==='dana' && !document.getElementById('proof').files.length){
        alert('Upload bukti pembayaran terlebih dahulu!');
        return;
      }

      let cashNote = '';
      if(payment.value==='cash'){
        cashNote = document.getElementById('cashNote').value.trim();
        localStorage.setItem(KEY_NOTE, cashNote); // simpan catatan terakhir
      }

      // update data user dengan alamat terbaru
      let userData = JSON.parse(localStorage.getItem(KEY_USER)) || {};
      if(Array.isArray(userData)) userData = userData[0];
      userData.name = name;
      userData.wa = wa;
      userData.address = address;
      localStorage.setItem(KEY_USER, JSON.stringify(userData));

      // tampilkan pesan konfirmasi
      let msg = `Pesanan berhasil dikonfirmasi!\n\nNama: ${name}\nWA: ${wa}\nAlamat: ${address}\nPembayaran: ${payment.value}`;
      if(cashNote) msg += `\nCatatan: ${cashNote}`;
      alert(msg);

      localStorage.removeItem(KEY_CART);
      window.location.href = 'terimaksih.html';
    });

    renderCart();
    fillBuyerData();
  </script>
</body>
</html>