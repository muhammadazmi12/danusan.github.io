<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Checkout</title>
  <style>
    body{font-family:Arial,Helvetica,sans-serif;background:#f9fafb;margin:0;padding:20px}
    h1{text-align:center;margin-bottom:20px}
    .card{background:#fff;padding:16px;border-radius:12px;box-shadow:0 4px 10px rgba(0,0,0,0.05);margin-bottom:16px}
    .item{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
    .item:last-child{margin-bottom:0}
    .total{font-weight:bold;font-size:18px;text-align:right;margin-top:10px}
    .radio-group{display:flex;gap:20px;margin-top:10px}
    .radio-group label{display:flex;align-items:center;gap:6px;margin:0}
    .hidden{display:none}
    button{margin-top:20px;width:100%;padding:12px;border:none;background:#2563eb;color:#fff;font-size:16px;font-weight:600;border-radius:8px;cursor:pointer}
    .upload-box{
      margin-top:15px;
      padding:15px;
      border:2px dashed #2563eb;
      border-radius:10px;
      background:#f0f9ff;
      text-align:center;
    }
    .upload-box label{
      display:block;
      font-weight:600;
      margin-bottom:8px;
      color:#1e3a8a;
    }
    .upload-box input[type="file"]{margin:5px 0;}
    .upload-box .note{font-size:13px;color:#475569;margin-top:5px}
    .warning{color:#b91c1c;font-size:14px;margin-top:8px;font-weight:500}
  </style>
</head>
<body>
  <h1>Checkout</h1>

  <div class="card" id="cartList"></div>

  <div class="card">
    <h3>Data Pembeli</h3>
    <p><strong>Nama:</strong> <span id="buyerName">-</span></p>
    <p><strong>Nomor WhatsApp:</strong> <span id="buyerWa">-</span></p>
  </div>

  <div class="card">
    <h3>Metode Pembayaran</h3>
    <div class="radio-group">
      <label><input type="radio" name="payment" value="dana"> DANA</label>
      <label><input type="radio" name="payment" value="cash"> Cash</label>
    </div>

    <!-- Info DANA -->
    <div id="danaInfo" class="hidden" style="margin-top:10px;">
      <p><strong>Nomor DANA:</strong> <span style="color:#2563eb;font-weight:600;">085174146390</span></p>
      <p><strong>Atas Nama:</strong> <span style="color:#16a34a;font-weight:600;">Cihuyy</span></p>
      <p class="warning">‚ö†Ô∏è Pastikan nomor tujuan dan jumlah transfer sesuai dengan total yang tertera agar pesanan dapat diproses.</p>
    </div>

    <!-- Upload Box -->
    <div id="uploadBox" class="hidden upload-box">
      <label for="proof">Upload Bukti Pembayaran</label>
      <input type="file" id="proof" accept="image/*">
      <p class="note">üì∏ Unggah screenshot bukti transfer Anda di sini</p>
    </div>
  </div>

  <button id="confirmBtn">Konfirmasi Pesanan</button>

  <script>
    const KEY_CART = 'cart';
    const KEY_USER = 'users';
    const ENDPOINT = "https://script.google.com/macros/s/AKfycbytPPUdeWp6LLi6Rn2bOyEWVkvdxqEe7uHRF6ypjXJtPlyEU58sqj10XpZ0lGuI5sw/exec";

    const products = [
      {id:1,name:'Sepatu Sport',price:350000},
      {id:2,name:'Tas Ransel',price:250000},
      {id:3,name:'Headphone',price:150000},
      {id:4,name:'Jam Tangan',price:500000}
    ];

    function formatRp(n){
      return 'Rp ' + n.toLocaleString('id-ID');
    }

    function renderCart(){
      const cartData = JSON.parse(localStorage.getItem(KEY_CART) || '{}');
      const container = document.getElementById('cartList');
      container.innerHTML = '<h3>Daftar Produk</h3>';
      let total = 0;
      let hasItem = false;

      for(const id in cartData){
        if(!Object.prototype.hasOwnProperty.call(cartData, id)) continue;
        const qty = cartData[id];
        const product = products.find(p=>p.id == id);
        if(product && qty > 0){
          hasItem = true;
          const sub = product.price * qty;
          total += sub;
          container.innerHTML += `
            <div class="item">
              <span>${product.name} x ${qty}</span>
              <span>${formatRp(sub)}</span>
            </div>
          `;
        }
      }

      if(!hasItem){
        container.innerHTML += '<p>Keranjang kosong.</p>';
      }

      container.innerHTML += `<div class="total">Total: ${formatRp(total)}</div>`;
    }

    function fillBuyerData(){
      const raw = localStorage.getItem(KEY_USER);
      if(!raw) return; // tidak ada data user

      let userData;
      try {
        userData = JSON.parse(raw);
      } catch (e) {
        userData = raw;
      }

      if(Array.isArray(userData) && userData.length > 0){
        userData = userData[0];
      }

      const nameEl = document.getElementById('buyerName');
      const waEl = document.getElementById('buyerWa');

      if(userData && typeof userData === 'object'){
        nameEl.textContent = userData.name || '-';
        waEl.textContent = userData.wa || '-';
      } else {
        nameEl.textContent = userData || '-';
        waEl.textContent = '-';
      }
    }

    function getCartData(){
      const cartData = JSON.parse(localStorage.getItem(KEY_CART) || '{}');
      let items = [];
      let total = 0;
      for(const id in cartData){
        if(!Object.prototype.hasOwnProperty.call(cartData, id)) continue;
        const qty = cartData[id];
        const product = products.find(p=>p.id == id);
        if(product && qty > 0){
          const sub = product.price * qty;
          total += sub;
          items.push({
            name: product.name,
            qty: qty,
            price: product.price,
            subtotal: sub
          });
        }
      }
      return {items, total};
    }

    // toggle upload box & info DANA
    document.querySelectorAll('input[name="payment"]').forEach(radio=>{
      radio.addEventListener('change', (e)=>{
        if(e.target.value === 'dana'){
          document.getElementById('uploadBox').classList.remove('hidden');
          document.getElementById('danaInfo').classList.remove('hidden');
        } else {
          document.getElementById('uploadBox').classList.add('hidden');
          document.getElementById('danaInfo').classList.add('hidden');
        }
      });
    });

    document.getElementById('confirmBtn').addEventListener('click', async ()=>{
      const buyerName = document.getElementById('buyerName').textContent;
      const buyerWa = document.getElementById('buyerWa').textContent;
      const payment = document.querySelector('input[name="payment"]:checked');

      if(!payment){
        alert('Pilih metode pembayaran terlebih dahulu!');
        return;
      }

      const cartInfo = getCartData();
      if(cartInfo.items.length === 0){
        alert('Keranjang masih kosong!');
        return;
      }

      const formData = new FormData();
      formData.append("name", buyerName);
      formData.append("wa", buyerWa);
      formData.append("payment", payment.value);
      formData.append("cart", JSON.stringify(cartInfo.items));
      formData.append("total", cartInfo.total);

      if(payment.value === "dana"){
        const proofFile = document.getElementById('proof').files[0];
        if(!proofFile){
          alert("Upload bukti pembayaran terlebih dahulu!");
          return;
        }
        formData.append("proof", proofFile);
      }

      try {
        const res = await fetch(ENDPOINT, {
          method: "POST",
          body: formData
        });

        if(res.ok){
          alert(`Pesanan berhasil dikonfirmasi! Terima kasih, ${buyerName}. Kami akan hubungi via WhatsApp ${buyerWa}.`);
          localStorage.removeItem(KEY_CART);
          window.location.href = 'index.html';
        } else {
          alert("Gagal mengirim data, coba lagi.");
        }
      } catch (err) {
        console.error(err);
        alert("Terjadi kesalahan saat mengirim data.");
      }
    });

    renderCart();
    fillBuyerData();
  </script>
</body>
</html>
